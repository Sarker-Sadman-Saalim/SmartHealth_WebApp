{% extends "base.html" %}
{% block content %}

<!-- Prediction Result Card -->
<div class="card">
    <div class="card-header">
        üéØ Your Obesity Prediction
    </div>
    <div class="card-body">
        <div style="text-align: center; padding: 2rem 0;">
            <div style="display: inline-block; padding: 2rem 3rem; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 15px; box-shadow: 0 8px 30px rgba(99, 102, 241, 0.5);">
                <h2 style="color: white; font-size: 2.5rem; margin: 0; font-weight: 800;">{{ prediction }}</h2>
            </div>
            <p style="margin-top: 1.5rem; font-size: 1.2rem; color: var(--text-secondary);">
                Based on your lifestyle and health information, your predicted category is: <strong style="color: var(--primary-light);">{{ prediction }}</strong>
            </p>
            <p style="margin-top: 1rem; font-size: 1.1rem; color: var(--text-muted);">
                Your BMI: <strong style="color: var(--primary-light);">{{ "%.2f"|format(user_input.Weight / (user_input.Height ** 2)) }}</strong>
            </p>
        </div>
    </div>
</div>

<!-- Class Probabilities Card -->
<div class="card">
    <div class="card-header">
        üìä Prediction Confidence
    </div>
    <div class="card-body">
        <div style="display: grid; gap: 1.5rem;">
            {% for cls, p in class_probs %}
            <div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                    <span style="font-weight: {{ 700 if loop.first else 600 }}; font-size: 1.1rem; color: {{ 'var(--primary-light)' if loop.first else 'var(--text-primary)' }};">
                        {{ cls.replace("_", " ") }}
                        {% if loop.first %}<span style="color: var(--accent);"> ‚Üê Your Result</span>{% endif %}
                    </span>
                    <span style="font-weight: 700; font-size: 1.1rem; color: var(--primary-light);">
                        {{ "%.1f"|format(p * 100) }}%
                    </span>
                </div>
                <div style="height: 45px; background: var(--bg-dark); border-radius: 25px; overflow: hidden; border: 1px solid var(--border);">
                    <div style="width: {{ p * 100 }}%; height: 100%; background: {{ 'linear-gradient(90deg, var(--primary), var(--accent))' if loop.first else 'var(--border)' }}; border-radius: 25px; transition: width 1.5s ease-out; display: flex; align-items: center; justify-content: flex-end; padding-right: 15px; color: white; font-weight: 700; font-size: 1rem;">
                        {{ "%.1f"|format(p * 100) }}%
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Explanation Card -->
<div class="card">
    <div class="card-header">
        üí° Key Factors in Your Result
    </div>
    <div class="card-body">
        <p style="margin-bottom: 1.5rem; color: var(--text-secondary); font-size: 1.05rem;">
            This prediction is based on the most important factors identified by our machine learning model:
        </p>
        <ul style="list-style: none; padding: 0;">
            {% for r in reasons %}
            <li style="padding: 1rem 1.25rem; margin-bottom: 1rem; background: var(--bg-dark); border-left: 4px solid var(--primary); border-radius: 8px; color: var(--text-primary); font-size: 1.05rem;">
                {{ r }}
            </li>
            {% endfor %}
        </ul>
        <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border-left: 5px solid var(--success);">
            <strong style="color: var(--success);">Important Note:</strong>
            <span style="color: var(--text-secondary);"> This is an AI prediction based on statistical models, not a medical diagnosis. Always consult healthcare professionals for personalized medical advice.</span>
        </div>
    </div>
</div>

<!-- User Input Summary Card -->
<div class="card">
    <div class="card-header">
        üìù Your Provided Information
    </div>
    <div class="card-body">
        <div class="grid">
            {% for key, value in user_input.items() %}
            <div style="padding: 1.25rem; background: var(--bg-dark); border-radius: 10px; border: 1px solid var(--border); transition: all 0.3s ease;">
                <div style="font-weight: 700; color: var(--primary-light); margin-bottom: 0.5rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">{{ key }}</div>
                <div style="font-size: 1.2rem; color: var(--text-primary); font-weight: 600;">{{ value }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Chatbot Section -->
<div class="card">
    <div class="card-header">
        üí¨ Ask the Obesity Guidance Assistant
    </div>
    <div class="card-body">
        <style>
            .chat-container {
                max-height: 500px;
                overflow-y: auto;
                padding: 1.5rem;
                background: var(--bg-dark);
                border-radius: 12px;
                margin-bottom: 1.5rem;
                border: 1px solid var(--border);
            }

            .chat-container::-webkit-scrollbar {
                width: 8px;
            }

            .chat-container::-webkit-scrollbar-thumb {
                background: var(--border);
                border-radius: 4px;
            }

            .chat-container::-webkit-scrollbar-thumb:hover {
                background: var(--primary);
            }

            .chat-message {
                display: flex;
                margin-bottom: 1.25rem;
                animation: fadeIn 0.4s ease;
            }

            @keyframes fadeIn {
                from { 
                    opacity: 0; 
                    transform: translateY(15px); 
                }
                to { 
                    opacity: 1; 
                    transform: translateY(0); 
                }
            }

            .chat-message.user {
                justify-content: flex-end;
            }

            .chat-message.assistant {
                justify-content: flex-start;
            }

            .chat-bubble {
                max-width: 75%;
                padding: 1.1rem 1.4rem;
                border-radius: 18px;
                line-height: 1.6;
                position: relative;
                font-size: 1.05rem;
            }

            .chat-message.user .chat-bubble {
                background: linear-gradient(135deg, var(--primary), var(--accent));
                color: white;
                border-bottom-right-radius: 4px;
                box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            }

            .chat-message.assistant .chat-bubble {
                background: var(--bg-card);
                color: var(--text-primary);
                border-bottom-left-radius: 4px;
                border: 1px solid var(--border);
                box-shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
            }

            .chat-message.user .chat-bubble::before {
                content: "You";
                position: absolute;
                top: -22px;
                right: 10px;
                font-size: 0.75rem;
                color: var(--text-muted);
                font-weight: 600;
            }

            .chat-message.assistant .chat-bubble::before {
                content: "‚öïÔ∏è Assistant";
                position: absolute;
                top: -22px;
                left: 10px;
                font-size: 0.75rem;
                color: var(--text-muted);
                font-weight: 600;
            }

            .empty-chat {
                text-align: center;
                padding: 3rem 1rem;
                color: var(--text-muted);
            }

            .empty-chat-icon {
                font-size: 3.5rem;
                margin-bottom: 1rem;
                opacity: 0.7;
            }
        </style>

        <div class="chat-container">
            {% if chat_history %}
                {% for msg in chat_history %}
                <div class="chat-message {{ msg.role }}">
                    <div class="chat-bubble">
                        {{ msg.message }}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-chat">
                    <div class="empty-chat-icon">üí¨</div>
                    <p style="font-size: 1.2rem; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">No messages yet</p>
                    <p style="color: var(--text-muted);">Ask a question about your results, lifestyle changes, or health improvements.</p>
                </div>
            {% endif %}
        </div>

        <form method="POST" action="/chat">
            <div class="form-group">
                <textarea 
                    name="user_message" 
                    rows="3" 
                    class="form-input" 
                    placeholder="Ask about your results, diet recommendations, exercise plans, etc." 
                    required
                    style="resize: vertical; min-height: 90px;"
                ></textarea>
            </div>
            <input type="hidden" name="prediction" value="{{ prediction }}">
            <button type="submit" class="btn btn-primary" style="width: 100%; font-size: 1.1rem; padding: 1rem;">
                üì§ Send Message
            </button>
        </form>

        <div style="margin-top: 1.5rem; padding: 1.25rem; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 10px; display: flex; align-items: center; gap: 1rem;">
            <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
            <p style="margin: 0; font-size: 0.95rem; color: var(--text-secondary);">
                <strong style="color: var(--warning);">Disclaimer:</strong> This assistant provides general information only and is not a substitute for medical advice. Please consult healthcare professionals for personalized guidance.
            </p>
        </div>
    </div>
</div>

<!-- Back to Home Button -->
<div style="text-align: center; margin: 2.5rem 0;">
    <a href="/" class="btn btn-primary" style="display: inline-block; text-decoration: none; padding: 1.2rem 3rem; font-size: 1.15rem;">
        üè† Start New Assessment
    </a>
</div>

<script>
    // Smooth scroll to top on page load
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Auto-scroll chat to bottom if messages exist
    const chatContainer = document.querySelector('.chat-container');
    if (chatContainer && chatContainer.children.length > 1) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
</script>

{% endblock %}